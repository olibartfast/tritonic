name: Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: AI Code Review
      uses: freeedcom/ai-codereviewer@v2
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        exclude: "**/*.md,**/*.txt,**/*.json,**/*.yaml,**/*.yml,**/labels/**,**/data/**"
        max_files: 10

  conventional-commits:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check Conventional Commits
      uses: webiny/action-conventional-commits@v1.3.0

  pr-labels:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Label PR
      uses: actions/labeler@v5
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        configuration-path: .github/labeler.yml

  complexity-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install lizard
      run: pip install lizard

    - name: Run Complexity Analysis
      run: |
        echo "## Code Complexity Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files with High Complexity (CCN > 15)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        lizard -l cpp -w -L 50 -C 15 src/ include/ || true
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** Functions with Cyclomatic Complexity > 15 should be refactored." >> $GITHUB_STEP_SUMMARY

  review-stats:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: PR Statistics
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const files = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: pr.number,
          });
          
          const stats = files.data.reduce((acc, file) => {
            acc.totalFiles++;
            acc.additions += file.additions;
            acc.deletions += file.deletions;
            acc.changes += file.changes;
            
            const ext = file.filename.split('.').pop();
            acc.fileTypes[ext] = (acc.fileTypes[ext] || 0) + 1;
            
            return acc;
          }, {
            totalFiles: 0,
            additions: 0,
            deletions: 0,
            changes: 0,
            fileTypes: {}
          });
          
          const summary = `## Pull Request Statistics
          
          ðŸ“Š **Changes Overview:**
          - **Files Changed:** ${stats.totalFiles}
          - **Lines Added:** ${stats.additions}
          - **Lines Deleted:** ${stats.deletions}
          - **Total Changes:** ${stats.changes}
          
          ðŸ“ **File Types:**
          ${Object.entries(stats.fileTypes).map(([ext, count]) => `- ${ext}: ${count}`).join('\n')}
          
          âš ï¸ **Review Notes:**
          ${stats.totalFiles > 20 ? '- This is a large PR. Consider breaking it into smaller PRs for easier review.' : ''}
          ${stats.changes > 500 ? '- High number of changes. Thorough review recommended.' : ''}
          ${stats.additions > stats.deletions * 3 ? '- PR adds significantly more code than it removes.' : ''}
          `;
          
          core.summary.addRaw(summary).write();
